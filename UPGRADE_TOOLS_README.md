# 🛠️ 升级工具包说明

## 📦 工具包概述

本升级工具包为HKGAI模型评测系统提供**零数据丢失**的安全升级解决方案，专门用于部署分享功能更新。

## 📁 文件清单

### 🔧 可执行脚本
| 文件名 | 功能 | 用途 |
|--------|------|------|
| `upgrade.sh` | **一键升级脚本** | 自动化完整升级流程 |
| `upgrade_backup.sh` | **数据备份脚本** | 备份数据库和文件 |
| `db_migration.py` | **数据库迁移脚本** | 安全添加新表结构 |
| `pre_upgrade_check.py` | **升级前检查脚本** | 环境和数据完整性检查 |

### 📚 文档指南
| 文件名 | 内容 | 适用场景 |
|--------|------|----------|
| `UPGRADE_GUIDE.md` | **详细升级指南** | 手动升级和故障排除 |
| `QUICK_UPGRADE.md` | **快速升级指引** | 简化版本，快速上手 |
| `UPGRADE_TOOLS_README.md` | **工具包说明** | 了解所有工具用途 |

## 🚀 使用方法

### 方案一：一键升级 (推荐)
```bash
# 1. 升级前检查
./pre_upgrade_check.py

# 2. 一键升级
./upgrade.sh
```

### 方案二：分步升级
```bash
# 1. 数据备份
./upgrade_backup.sh

# 2. 数据库迁移
python3 db_migration.py  

# 3. 启动服务
python3 app.py
```

### 方案三：手动升级
参考 `UPGRADE_GUIDE.md` 详细步骤

## 🛡️ 安全特性

### ✅ 数据保护
- **自动备份**: 升级前自动备份数据库和关键文件
- **增量迁移**: 仅添加新表，不修改现有数据
- **事务安全**: 数据库操作使用事务，失败自动回滚
- **多重验证**: 升级后自动验证数据完整性

### ✅ 故障恢复
- **备份恢复**: 提供一键恢复备份数据功能
- **回滚机制**: 支持版本回退到升级前状态
- **错误诊断**: 详细的错误日志和诊断信息

## 📊 本次升级内容

### 🆕 新增功能
- **评测结果分享**: 生成公开分享链接
- **密码保护**: 可选的访问密码设置
- **访问控制**: 过期时间和访问次数限制
- **访问统计**: 分享链接使用情况记录

### 🗄️ 数据库变更
- **新增表**: `shared_links` (分享链接)
- **新增表**: `shared_access_logs` (访问日志)  
- **新增索引**: 5个性能优化索引

### 📄 新增模板
- `templates/shared_result.html` - 分享结果页面
- `templates/shared_password.html` - 密码验证页面
- `templates/shared_error.html` - 错误提示页面

## 🔍 升级前自检

在升级前，请运行检查脚本确保环境就绪：

```bash
./pre_upgrade_check.py
```

检查项目包括：
- ✅ 必要文件存在性检查
- ✅ 数据库结构和数据完整性
- ✅ Python环境和依赖包
- ✅ 磁盘空间充足性
- ✅ 运行中进程状态

## ⚡ 升级时间估算

| 数据规模 | 预计用时 | 备份大小 |
|----------|----------|----------|
| 小型 (< 1GB) | 2-5分钟 | < 100MB |
| 中型 (1-5GB) | 5-15分钟 | 100MB-500MB |
| 大型 (> 5GB) | 15-30分钟 | > 500MB |

## 🆘 故障排除

### 常见问题

1. **权限错误**
   ```bash
   chmod +x *.sh *.py
   ```

2. **端口占用**
   ```bash
   lsof -i :8080
   pkill -f "python.*app.py"
   ```

3. **数据库锁定**
   ```bash
   # 确保没有其他进程使用数据库
   fuser evaluation_system.db
   ```

4. **Python依赖缺失**
   ```bash
   pip install -r requirements.txt
   ```

### 紧急恢复

如果升级失败，立即执行：
```bash
# 恢复数据库
cp backup_YYYYMMDD_HHMMSS/evaluation_system.db.backup evaluation_system.db

# 回退代码 (如果使用git)
git checkout HEAD~1

# 重启服务
python3 app.py
```

## 📞 技术支持

- **邮箱**: guozhenhua@hkgai.org
- **文档**: 查看 `UPGRADE_GUIDE.md` 获取详细信息
- **日志**: 升级过程会生成 `app.log` 和 `pre_upgrade_report.json`

## 📝 升级记录

升级完成后，请记录以下信息：
- 升级时间: _______________
- 升级前版本: _____________
- 升级后版本: _____________
- 数据备份位置: ___________
- 是否成功: _______________
- 负责人: _________________

---

## ⚠️ 重要提醒

1. **升级前务必备份数据**
2. **在低峰期进行升级**
3. **升级过程中不要中断操作**
4. **升级后验证所有功能正常**
5. **保留备份文件至少1周**

---

*本工具包由HKGAI模型评测系统团队开发，确保安全可靠的系统升级体验。*
