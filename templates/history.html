<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>评测历史 - AI模型评测系统</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .history-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .history-header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            display: block;
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .filters-panel {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .filters-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-group label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }
        
        .filter-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            min-width: 120px;
        }
        
        .tag-filter {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .tag-chip {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        
        .tag-chip:hover {
            background: #bbdefb;
        }
        
        .tag-chip.active {
            background: #1976d2;
            color: white;
        }
        
        .history-grid {
            display: grid;
            gap: 20px;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
        }
        
        .history-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border-left: 4px solid #4CAF50;
        }
        
        .history-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin: 0;
            line-height: 1.4;
        }
        
        .card-menu {
            display: flex;
            gap: 8px;
        }
        
        .card-btn {
            background: none;
            border: none;
            padding: 6px;
            border-radius: 4px;
            cursor: pointer;
            color: #666;
            transition: all 0.2s;
        }
        
        .card-btn:hover {
            background: #f5f5f5;
            color: #333;
        }
        
        .card-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #666;
        }
        
        .info-item i {
            color: #4CAF50;
            width: 16px;
        }
        
        .models-list {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        .model-badge {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            color: #495057;
        }
        
        .tags-container {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        .tag-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
        }
        
        .card-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state i {
            font-size: 3em;
            color: #ddd;
            margin-bottom: 20px;
        }
        
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 30px;
        }
        
        .pagination button {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .pagination button:hover:not(:disabled) {
            background: #f5f5f5;
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination .current {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        
        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background: white;
            margin: 3% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            overflow: hidden;
        }
        
        .modal-header {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .summary-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .summary-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #4CAF50;
        }
        
        .summary-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #ffffff;
            background: #1976d2;
            text-decoration: none;
            margin-bottom: 20px;
            font-weight: 500;
            padding: 10px 16px;
            border-radius: 6px;
            border: 2px solid #1976d2;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .back-link:hover {
            background: #1565c0;
            border-color: #1565c0;
            color: #ffffff;
            text-decoration: none;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body>
    <div class="history-container">
        <!-- 导航栏 -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <a href="/" class="back-link">
                <i class="fas fa-arrow-left"></i>
                返回主页
            </a>
            <div class="user-nav">
                <span class="user-display">欢迎, <strong>{{ current_user.display_name or current_user.username }}</strong></span>
                <button class="btn btn-outline" onclick="logout()" title="退出登录" style="margin-left: 15px;">
                    <i class="fas fa-sign-out-alt"></i> 退出
                </button>
            </div>
        </div>
        
        <!-- 页面头部 -->
        <div class="history-header">
            <h1><i class="fas fa-history"></i> 评测历史管理</h1>
            <p>专业的评测结果存储、检索和分析系统</p>
            
            <div class="stats-grid" id="stats-grid">
                <!-- 统计信息将通过JavaScript加载 -->
            </div>
            
            <div class="action-buttons" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="refreshHistory()">
                    <i class="fas fa-sync-alt"></i> 刷新
                </button>
                <button class="btn btn-secondary" onclick="archiveOldResults()">
                    <i class="fas fa-archive"></i> 归档旧结果
                </button>
                <button class="btn btn-success" onclick="exportHistory()">
                    <i class="fas fa-download"></i> 导出历史
                </button>
            </div>
        </div>
        
        <!-- 筛选面板 -->
        <div class="filters-panel">
            <div class="filters-row">
                <div class="filter-group">
                    <label>搜索</label>
                    <input type="text" class="filter-input" id="search-input" placeholder="搜索名称、模型...">
                </div>
                
                <div class="filter-group">
                    <label>评测模式</label>
                    <select class="filter-input" id="mode-filter">
                        <option value="">全部模式</option>
                        <option value="objective">客观题</option>
                        <option value="subjective">主观题</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>时间范围</label>
                    <select class="filter-input" id="time-filter">
                        <option value="">全部时间</option>
                        <option value="today">今天</option>
                        <option value="week">本周</option>
                        <option value="month">本月</option>
                        <option value="quarter">本季度</option>
                    </select>
                </div>
                
                <button class="btn btn-secondary" onclick="resetFilters()">
                    <i class="fas fa-undo"></i> 重置
                </button>
            </div>
            
            <div class="tag-filter" id="tag-filter" style="margin-top: 15px;">
                <label>标签筛选：</label>
                <!-- 标签将通过JavaScript动态加载 -->
            </div>
        </div>
        
        <!-- 历史记录网格 -->
        <div class="loading-spinner" id="loading">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p>加载中...</p>
        </div>
        
        <div class="history-grid" id="history-grid">
            <!-- 历史记录卡片将通过JavaScript动态生成 -->
        </div>
        
        <div class="empty-state" id="empty-state" style="display: none;">
            <i class="fas fa-inbox"></i>
            <h3>暂无评测历史</h3>
            <p>开始您的第一次评测，记录将会出现在这里</p>
        </div>
        
        <!-- 分页 -->
        <div class="pagination" id="pagination">
            <!-- 分页控件将通过JavaScript生成 -->
        </div>
    </div>
    
    <!-- 详情模态框 -->
    <div class="modal" id="detail-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-chart-line"></i> 评测详情</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- 详情内容将通过JavaScript生成 -->
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentPage = 1;
        let pageSize = 12;
        let totalResults = 0;
        let currentFilters = {};
        let availableTags = [];
        let selectedTags = [];
        
        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadStatistics();
            loadAvailableTags();
            loadHistory();
            setupEventListeners();
        });
        
        // 设置事件监听器
        function setupEventListeners() {
            // 搜索框防抖
            let searchTimeout;
            document.getElementById('search-input').addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    currentPage = 1;
                    loadHistory();
                }, 500);
            });
            
            // 筛选器变化
            document.getElementById('mode-filter').addEventListener('change', () => {
                currentPage = 1;
                loadHistory();
            });
            
            document.getElementById('time-filter').addEventListener('change', () => {
                currentPage = 1;
                loadHistory();
            });
        }
        
        // 加载统计信息
        async function loadStatistics() {
            try {
                const response = await fetch('/api/history/statistics');
                const stats = await response.json();
                
                const statsGrid = document.getElementById('stats-grid');
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <span class="stat-number">${stats.total_evaluations || 0}</span>
                        <div class="stat-label">总评测次数</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number">${stats.total_annotations || 0}</span>
                        <div class="stat-label">总标注数</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number">${stats.total_result_files || 0}</span>
                        <div class="stat-label">结果文件数</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number">${stats.total_disk_usage || '0 B'}</span>
                        <div class="stat-label">磁盘使用</div>
                    </div>
                `;
            } catch (error) {
                console.error('加载统计信息失败:', error);
            }
        }
        
        // 加载可用标签
        async function loadAvailableTags() {
            try {
                const response = await fetch('/api/history/tags');
                availableTags = await response.json();
                
                const tagFilter = document.getElementById('tag-filter');
                const tagsHtml = availableTags.map(tag => `
                    <span class="tag-chip" onclick="toggleTag('${tag}')">${tag}</span>
                `).join('');
                
                tagFilter.innerHTML = '<label>标签筛选：</label>' + tagsHtml;
            } catch (error) {
                console.error('加载标签失败:', error);
            }
        }
        
        // 切换标签选择
        function toggleTag(tag) {
            const index = selectedTags.indexOf(tag);
            if (index > -1) {
                selectedTags.splice(index, 1);
            } else {
                selectedTags.push(tag);
            }
            
            // 更新UI
            updateTagDisplay();
            currentPage = 1;
            loadHistory();
        }
        
        // 更新标签显示
        function updateTagDisplay() {
            const tagChips = document.querySelectorAll('.tag-chip');
            tagChips.forEach(chip => {
                const tag = chip.textContent;
                chip.classList.toggle('active', selectedTags.includes(tag));
            });
        }
        
        // 加载历史记录
        async function loadHistory() {
            const loading = document.getElementById('loading');
            const historyGrid = document.getElementById('history-grid');
            const emptyState = document.getElementById('empty-state');
            
            loading.style.display = 'block';
            historyGrid.style.display = 'none';
            emptyState.style.display = 'none';
            
            try {
                // 构建查询参数
                const params = new URLSearchParams({
                    page: currentPage,
                    limit: pageSize
                });
                
                const searchTerm = document.getElementById('search-input').value;
                if (searchTerm) params.append('search', searchTerm);
                
                const mode = document.getElementById('mode-filter').value;
                if (mode) params.append('mode', mode);
                
                const timeRange = document.getElementById('time-filter').value;
                if (timeRange) params.append('time_range', timeRange);
                
                if (selectedTags.length > 0) {
                    params.append('tags', selectedTags.join(','));
                }
                
                const response = await fetch(`/api/history/list?${params}`);
                const data = await response.json();
                
                if (data.success) {
                    renderHistoryGrid(data.results);
                    renderPagination(data.total);
                    totalResults = data.total;
                } else {
                    throw new Error(data.error || '加载失败');
                }
                
            } catch (error) {
                console.error('加载历史记录失败:', error);
                showError('加载历史记录失败: ' + error.message);
            } finally {
                loading.style.display = 'none';
            }
        }
        
        // 渲染历史记录网格
        function renderHistoryGrid(results) {
            const historyGrid = document.getElementById('history-grid');
            const emptyState = document.getElementById('empty-state');
            
            if (results.length === 0) {
                historyGrid.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            historyGrid.style.display = 'grid';
            historyGrid.innerHTML = results.map(result => createHistoryCard(result)).join('');
        }
        
        // 创建历史记录卡片
        function createHistoryCard(result) {
            const createdAt = new Date(result.created_at).toLocaleString('zh-CN');
            const completedAt = result.completed_at ? new Date(result.completed_at).toLocaleString('zh-CN') : '未完成';
            
            const modelsHtml = result.models.map(model => 
                `<span class="model-badge">${model}</span>`
            ).join('');
            
            const tagsHtml = result.tags.map(tag => 
                `<span class="tag-badge">${tag}</span>`
            ).join('');
            
            const statusIcon = result.status === 'completed' ? 'fa-check-circle' : 
                              result.status === 'running' ? 'fa-spinner fa-spin' : 'fa-exclamation-circle';
            const statusColor = result.status === 'completed' ? '#4CAF50' : 
                               result.status === 'running' ? '#FF9800' : '#f44336';
            
            return `
                <div class="history-card">
                    <div class="card-header">
                        <h3 class="card-title">${result.name}</h3>
                        <div class="card-menu">
                            <button class="card-btn" onclick="viewDetail('${result.id}')" title="查看详情">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="card-btn" onclick="renameResult('${result.id}', '${result.name.replace(/'/g, '\\\'')}')" title="重命名">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="card-btn" onclick="downloadResult('${result.id}')" title="下载结果">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="card-btn" onclick="deleteResult('${result.id}')" title="删除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="card-info">
                        <div class="info-item">
                            <i class="fas ${statusIcon}" style="color: ${statusColor}"></i>
                            <span>${result.status === 'completed' ? '已完成' : result.status === 'running' ? '运行中' : '失败'}</span>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-calendar"></i>
                            <span>${createdAt}</span>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-file-alt"></i>
                            <span>${result.file_size || '未知'}</span>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-cog"></i>
                            <span>${result.evaluation_mode === 'objective' ? '客观题' : '主观题'}</span>
                        </div>
                    </div>
                    
                    <div class="models-list">
                        ${modelsHtml}
                    </div>
                    
                    <div class="tags-container">
                        ${tagsHtml}
                    </div>
                    
                    <div class="card-actions">
                        <button class="btn btn-sm btn-primary" onclick="viewResult('${result.id}')">
                            <i class="fas fa-chart-bar"></i> 查看结果
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="annotateResult('${result.id}')">
                            <i class="fas fa-tags"></i> 标注
                        </button>
                    </div>
                </div>
            `;
        }
        
        // 渲染分页
        function renderPagination(total) {
            const pagination = document.getElementById('pagination');
            const totalPages = Math.ceil(total / pageSize);
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let paginationHtml = `
                <button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                    <i class="fas fa-chevron-left"></i>
                </button>
            `;
            
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHtml += `
                    <button onclick="changePage(${i})" ${i === currentPage ? 'class="current"' : ''}>
                        ${i}
                    </button>
                `;
            }
            
            paginationHtml += `
                <button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                    <i class="fas fa-chevron-right"></i>
                </button>
            `;
            
            pagination.innerHTML = paginationHtml;
        }
        
        // 切换页面
        function changePage(page) {
            const totalPages = Math.ceil(totalResults / pageSize);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                loadHistory();
            }
        }
        
        // 查看详情
        async function viewDetail(resultId) {
            try {
                const response = await fetch(`/api/history/detail/${resultId}`);
                const data = await response.json();
                
                if (data.success) {
                    showDetailModal(data.result);
                } else {
                    showError(data.error || '获取详情失败');
                }
            } catch (error) {
                showError('获取详情失败: ' + error.message);
            }
        }
        
        // 显示详情模态框
        function showDetailModal(result) {
            const modal = document.getElementById('detail-modal');
            const modalBody = document.getElementById('modal-body');
            
            const summary = result.result_summary || {};
            const annotations = result.annotations || [];
            
            modalBody.innerHTML = `
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-value">${summary.total_questions || 0}</div>
                        <div class="summary-label">总题数</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">${result.models?.length || 0}</div>
                        <div class="summary-label">模型数</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">${annotations.length}</div>
                        <div class="summary-label">标注数</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">${result.total_rows || 0}</div>
                        <div class="summary-label">数据行数</div>
                    </div>
                </div>
                
                <h4><i class="fas fa-info-circle"></i> 基本信息</h4>
                <div style="margin-bottom: 20px;">
                    <p><strong>名称：</strong>${result.name}</p>
                    <p><strong>数据集：</strong>${result.dataset_file}</p>
                    <p><strong>评测模式：</strong>${result.evaluation_mode === 'objective' ? '客观题' : '主观题'}</p>
                    <p><strong>创建时间：</strong>${new Date(result.created_at).toLocaleString('zh-CN')}</p>
                    <p><strong>完成时间：</strong>${result.completed_at ? new Date(result.completed_at).toLocaleString('zh-CN') : '未完成'}</p>
                </div>
                
                <h4><i class="fas fa-robot"></i> 参与模型</h4>
                <div style="margin-bottom: 20px;">
                    ${result.models?.map(model => `<span class="model-badge">${model}</span>`).join(' ') || '无'}
                </div>
                
                <h4><i class="fas fa-tags"></i> 标签</h4>
                <div style="margin-bottom: 20px;">
                    ${result.tags?.map(tag => `<span class="tag-badge">${tag}</span>`).join(' ') || '无标签'}
                </div>
                
                ${result.data_preview ? `
                <h4><i class="fas fa-table"></i> 数据预览</h4>
                <div style="overflow-x: auto; margin-bottom: 20px;">
                    <table class="table" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr>
                                ${result.columns?.map(col => `<th style="border: 1px solid #ddd; padding: 8px; background: #f5f5f5;">${col}</th>`).join('') || ''}
                            </tr>
                        </thead>
                        <tbody>
                            ${result.data_preview.slice(0, 5).map(row => `
                                <tr>
                                    ${result.columns?.map(col => `<td style="border: 1px solid #ddd; padding: 8px;">${String(row[col] || '').substring(0, 50)}${String(row[col] || '').length > 50 ? '...' : ''}</td>`).join('') || ''}
                                </tr>
                            `).join('') || ''}
                        </tbody>
                    </table>
                </div>` : ''}
            `;
            
            modal.style.display = 'block';
        }
        
        // 关闭模态框
        function closeModal() {
            document.getElementById('detail-modal').style.display = 'none';
        }
        
        // 下载结果
        function downloadResult(resultId) {
            window.open(`/api/history/download/${resultId}`, '_blank');
        }
        
        // 查看结果
        function viewResult(resultId) {
            window.open(`/view_history/${resultId}`, '_blank');
        }
        
        // 标注结果
        function annotateResult(resultId) {
            window.open(`/annotate/${resultId}`, '_blank');
        }
        
        // 重命名结果
        async function renameResult(resultId, currentName) {
            // 从当前名称中移除时间戳后缀，提取用户友好的名称
            const cleanName = currentName.replace(/_\d{8}_\d{6}$/, '');
            
            const newName = prompt('请输入新的结果名称:', cleanName);
            if (newName === null || newName.trim() === '') {
                return;
            }
            
            const trimmedName = newName.trim();
            if (trimmedName === cleanName) {
                return; // 名称没有变化
            }
            
            if (trimmedName.length > 100) {
                showError('名称长度不能超过100个字符');
                return;
            }
            
            try {
                const response = await fetch(`/api/history/rename/${resultId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        new_name: trimmedName
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('重命名成功');
                    loadHistory();
                } else {
                    showError(data.error || '重命名失败');
                }
            } catch (error) {
                showError('重命名失败: ' + error.message);
            }
        }

        // 删除结果
        async function deleteResult(resultId) {
            if (!confirm('确定要删除这个评测结果吗？\n\n⚠️ 此操作将同时删除：\n• 数据库中的评测记录\n• 对应的CSV结果文件\n• 相关的历史文件\n\n此操作不可恢复！')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/history/delete/${resultId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    let successMsg = data.message || '删除成功';
                    if (data.deleted_files && data.deleted_files.length > 0) {
                        successMsg += `\n已删除 ${data.deleted_files.length} 个相关文件`;
                    }
                    showSuccess(successMsg);
                    loadHistory();
                    loadStatistics();
                } else {
                    showError(data.error || '删除失败');
                }
            } catch (error) {
                showError('删除失败: ' + error.message);
            }
        }
        
        // 刷新历史
        function refreshHistory() {
            loadHistory();
            loadStatistics();
            loadAvailableTags();
        }
        
        // 归档旧结果
        async function archiveOldResults() {
            if (!confirm('确定要归档90天前的旧结果吗？')) {
                return;
            }
            
            try {
                const response = await fetch('/api/history/archive', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess(`成功归档 ${data.archived_count} 个结果`);
                    loadHistory();
                    loadStatistics();
                } else {
                    showError(data.error || '归档失败');
                }
            } catch (error) {
                showError('归档失败: ' + error.message);
            }
        }
        
        // 导出历史
        function exportHistory() {
            // TODO: 实现历史导出功能
            alert('导出功能开发中...');
        }
        
        // 重置筛选
        function resetFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('mode-filter').value = '';
            document.getElementById('time-filter').value = '';
            selectedTags = [];
            updateTagDisplay();
            currentPage = 1;
            loadHistory();
        }
        
        // 显示成功消息
        function showSuccess(message) {
            // 简单实现，可以替换为更好的通知组件
            alert(message);
        }
        
        // 显示错误消息
        function showError(message) {
            // 简单实现，可以替换为更好的通知组件
            alert('错误: ' + message);
        }
        
        // 点击模态框外部关闭
        window.onclick = function(event) {
            const modal = document.getElementById('detail-modal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // 退出登录
        async function logout() {
            if (confirm('确定要退出登录吗？')) {
                try {
                    const response = await fetch('/logout', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        alert('已退出登录');
                        // 重定向到登录页面
                        setTimeout(() => {
                            window.location.href = result.redirect || '/login';
                        }, 1000);
                    } else {
                        alert('退出登录失败');
                    }
                } catch (error) {
                    console.error('退出登录错误:', error);
                    alert('退出登录时发生错误');
                }
            }
        }
    </script>
</body>
</html>
